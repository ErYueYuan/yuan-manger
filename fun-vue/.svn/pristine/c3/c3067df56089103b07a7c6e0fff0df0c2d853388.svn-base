<template>
    <div class="bg7">
        <div class="main-top  bg7 b-radius2">
            <section>
                <form action="/">
                    <van-search
                        v-model="value"
                        show-action
                        placeholder="请输入客户姓名"
                        shape="round"
                        @search="onSearch"
                        @cancel="goBack"
                        @clear="clearList"
                    />
                </form>
            </section>
        </div>
        <!-- 搜索历史 -->
        <div class="main-container clearfix" v-if="!isShowResult">
            <div class="pad5 f2-1 c5">搜索历史
                <span class="f-right" @click="delHistory()">
                    <b class="fun-icon icon-del " title="删除"></b>
                </span>
            </div>
            <section class="tab-box2">
                <span class=" c-p" v-for="(item, index) in historyList" :key="index" @click="queryHistory(item)">{{item}}</span>
            </section>
        </div>
        <!-- 搜索结果 -->
        <div class=" clearfix"  v-for="(item,index) in customerList" :key="index" v-show="isShowResult" @click="goDetail(item)">
            <div class="b-sh1 pad5-5 bg7  mar6-1">
                <div class="blk-cont-box posi2  ">
                      <lazy-component  class="img-box posi2">
                        <img v-if="!!item.head" v-lazy="item.head" />
                        <img v-if="!item.head" src="../../assets/img/index/bar_bg.png" alt="pic" />
                        <b class="state c-p" v-show="item.batchApplyMode == 1">系统分配</b>
                        <b class="state c-p" v-show="item.batchApplyMode == 2">主动取数</b>
                        <b class="state c-p" v-show="item.batchApplyMode == 3">自建客户</b>
                        <!-- <b class="state c-p" v-show="item.batchApplyMode == 4">成交客户</b> -->
                      </lazy-component>
                    <div class="right-box posi2  c-p" >
                        <h3 class="f2 c6 mar7-2"><span>{{item.name}}</span></h3>
                        <div class="f2 c4 ">
                            <span>年龄：</span><span>{{item.age != '未知' ? item.age + '岁' : item.age}}</span>
                            <b v-if="!!item.sex && item.sex == '1'" class="s-icon b3"></b>
                            <b v-if="!!item.sex && item.sex == '0'" class="s-icon b4"></b>
                            <b v-if="!!item.sex && item.sex == '2'" class="s-icon"></b>
                        </div>
                        <div class=" f2 c4">
                            <span>客户星级：</span>
                            <span class="stars-box" v-if="item.customerStar == '1'"><i></i><i class="grey"></i><i class="grey"></i><i class="grey"></i><i class="grey"></i></span>
                            <span class="stars-box" v-if="item.customerStar == '2'"><i></i><i></i><i class="grey"></i><i class="grey"></i><i class="grey"></i></span>
                            <span class="stars-box" v-if="item.customerStar == '3'"><i></i><i></i><i></i><i class="grey"></i><i class="grey"></i></span>
                            <span class="stars-box" v-if="item.customerStar == '4'"><i></i><i></i><i></i><i></i><i class="grey"></i></span>
                            <span class="stars-box" v-if="item.customerStar == '5'"><i></i><i></i><i></i><i></i><i></i></span>
                        </div>
                        <div class=" f2 c4">
                            <span>订单状态：</span><span>{{!!item.orderStatus ? item.orderStatus : '暂无'}}</span>
                        </div>
                        <div class=" f2 c4">
                            <span>创建时间：</span><span>{{item.date | dataFormat('yyyy-MM-dd hh:mm:ss')}}</span>
                        </div>
                        <div class="f1" v-if="!!item.activitySource"><b class="ek-btn-5">{{item.activitySource}}</b></div>
                        <div class="f1" v-if="!!item.officialAccountName"><b class="ek-btn-5">{{item.officialAccountName}}</b></div>
                    </div>
                    <b class="flag">客户行销</b>
                </div>
            </div>

        </div>
        <van-empty v-show="total===0" description="暂无该客户" />
        <div class="f2 pad888" v-if="customerList.length>=total && customerList.length>0">
            <div class="lzg-h-more posi2 t-center">
                <span class="c5 bg7 posi2 c222">没有更多啦</span>
            </div>
        </div>
    </div>
</template>
<script>
    import Vue from 'vue'
    import { mapGetters } from 'vuex'
    import * as tool from '@/common/Tool'
    import { api_sell } from '@/api/index'
    import DataSource from '@/common/DataSource'
    import '@vant/touch-emulator'
    import { Search, Empty, Lazyload } from 'vant'
    import * as scroll from '@/common/Scroll'

    Vue.use(Search).use(Empty).use(Lazyload, { lazyComponent: true })
    Vue.use(Empty)

    export default {
        name: "SearchResult",
        data () {
            return {
                value: '',
                customerList: [],
                historyCustomerList: [],
                historyList: [],
                // total: 0,
                total: 1,
                isLoad: true,
                allLoaded: false,
                queryLoading: true,
                offset: 0,
                limit: 10,
                isShowResult: false,
            }
        },
        computed: {
            ...mapGetters(['user']),
        },
        components: {

        },
        beforeCreate: function() {
            document.getElementsByTagName("body")[0].className = "bg7";
        },
        created () {

        },
        mounted () {
            this.getsource();
            window.addEventListener('scroll', this.handleScroll)
        },
        methods: {
            getsource() {
                this.historyList =  DataSource.get('historyList',1) ? DataSource.get('historyList',1) : [];
            },

            onSearch(val) {
                this.getCustomerList(val);
                this.searchName = val;
                let index = this.historyList.indexOf(val);
                if (index == -1) { // -1 没有，有就返回索引值
                    this.historyList.push(val);
                    DataSource.set('historyList', this.historyList, 1);
                }
            },

            handleScroll() {
                if (scroll.getScrollTop() + scroll.getClientHeight() > (scroll.getScrollHeight() - 5)) {
                    this.loadMore();
                }
            },

            loadMore() {
                if (this.queryLoading) {
                    return
                }
                if (!this.isLoad) {
                    this.isLoad = true;
                    this.offset += 10;
                    this.getCustomerList(this.searchName);
                }
            },

            

            getCustomerList (val) {
                const _data = {
                    saasId: tool.app.saasId,
                    agentUserId: this.user.userInfo.userId,
                    offset: this.offset,
                    limit: this.limit,
                    name: val ? val : ""
                }
                api_sell.getCustomerList(_data).then(data => {
                    if (data.status == tool.rtCode.status) {
                        this.isShowResult = true;
                        this.isLoad = false;
                        this.total = data.total;
                        if (this.offset === 0 || this.customerList.length === 0) {
                            this.customerList = data.customerList ? data.customerList : []
                            if (this.customerList.length < this.total) {
                                this.queryLoading = false;
                            }
                        } else {
                            this.customerList = this.customerList.concat(data.customerList);
                        }
                        this.allLoaded = this.customerList.length >= this.total;
                        if (this.allLoaded) {
                            this.queryLoading = true;
                        }
                    } else {
                        tool.toastMessage(data.message, 'error');
                    }
                })
            },

            goDetail (item) {
                // this.$router.push({ name: 'customerDetail',params: {
                //     q: item.clientId,
                //     r: item.clientNewId,
                //     s: item.resultId
                // } })
                this.$router.push({ name: 'customerDetail',params: {
                    q: item.clientId,
                    r: item.resultId
                } })
            },

            delHistory () {
                this.historyList = [];
                DataSource.set('historyList', '', 1);
            },

            queryHistory (name) {
                this.getCustomerList(name);
            },

            clearList () {
                this.isShowResult = false;
            },

            goBack () {
                // this.$router.push({ name: 'sellList', params: {
                //     q: '1'
                // } })
                this.$router.go(-1);
            },
        },
        beforeDestroy: function() {
            document.body.removeAttribute("class", "bg7");
        },
        destroyed() {
            window.removeEventListener('scroll', this.handleScroll)
        },
    }
</script>
<style scoped>

</style>
