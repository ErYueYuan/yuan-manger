<template>
  <div class="bg5">
  </div>
</template>

<script>
  // @ is an alias to /src
  import {api_user} from '@/api/index';
  import DataSource from '@/common/DataSource';
  import * as tool from '@/common/Tool';
  import _FanhWebVisit from '@/assets/js/fhWebVisit.js'

  export default {
    name: 'login',
    data() {
      return {
        q: this.$route.params.q,//openid
        r: this.$route.params.r,//url
      }
    },
    created: function () {
      this.wxLogin();
    },
    methods: {
      wxLogin() {
        api_user.login({
          openid: this.q,
          saasId: tool.app.saasId
        })
          .then(res => {
            if (res.status == tool.rtCode.status) {
              DataSource.set('userInfo', res, 1);
              DataSource.set('token', res.token, 1);
              DataSource.set('firUrl', window.location.href, 1);
              tool.setUser(res);
              let logJson = {
                userAgent: window.navigator.userAgent.toLowerCase(),
                userId: res.userId || '',
                sfId: res.sfId || '',
                openid: res.openid,
                saasId: tool.app.saasId,
                name: res.name || res.nickname,
                mobile: res.mobile || '',
                idNo: res.idNo || '',
                clientId: res.clientId || '',
                channel: 'ekc'  //渠道标志，即应用标志,E管家为ekc
              }
              try {//行为日志
                if (typeof _FanhWebVisit != "undefined" && typeof _FanhWebVisit.putUserInfo != "undefined" && typeof _FanhWebVisit.putEventInfo == 'function') {
                  _FanhWebVisit.putUserInfo(logJson);
                }
                if (typeof _FanhWebVisit != "undefined" && typeof _FanhWebVisit.putEventInfo != "undefined" && typeof _FanhWebVisit.putEventInfo == 'function') {
                  _FanhWebVisit.putEventInfo('login', 'button');
                }
              } catch (e) {
                //
              }
              if (this.r) {
                this.redirect(this.r)
              } else {
                this.$router.push({name: 'home'});
              }
            } else {
              tool.toastMessage(res.message, 'error')
            }
          })
      },
      redirect(_url) {
        let _urlArr = _url.split("-")
        let url = _urlArr[0] //TODO   参数1-跳转路径，参数2-分享人的ID或工号，参数3-可能后续会加
        if (url.indexOf('signIn') != -1) {
          this.$router.push({name: 'signIn', params: {code: _urlArr[1], id: _urlArr[2], way: _urlArr[3]}})
        } else if (url.indexOf('signPromote') != -1) {
          this.$router.push({name: 'signPromote', params: {code: _urlArr[1], id: _urlArr[2]}})
        } else if (url.indexOf('signSelf') != -1) {
          this.$router.push({name: 'signInSelf', params: {code: _urlArr[1], id: _urlArr[2], way: _urlArr[3]}})
        } else if (url.indexOf('meetingList') != -1) {
          this.$router.push({name: 'meetingList'})
        } else if (url.indexOf('signUp') != -1) {
          this.$router.push({name: 'signUp', params: {code: _urlArr[1], id: _urlArr[2]}})
        } else if (url.indexOf('familyVerify') != -1) {
          this.$router.push({name: 'familyVerify', params: {fid: _urlArr[1], uid: _urlArr[2]}})
        } else if (url.indexOf('myAsset') != -1) {  //我的资产
          this.$router.push({name: 'myAsset'})
        } else if (url.indexOf('myInfo') != -1) {  //我的档案
          this.$router.push({name: 'myInfo'})
        } else if (url.indexOf('home') != -1) {
          this.$router.push({path: `/home`})
        }
      }
    }
  }
</script>
