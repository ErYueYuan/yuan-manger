<template>
  <div class="bg3">
    <div class="fun-top-panel bg9 ">
      <span
        class="mess-back "
        @click="goBack()"
      >
        <div class="cont-wh"></div>
      </span>
      <span class="title c7 f3 dblock2 t-center ">营销政策</span>
    </div>
    <div class="main-top p-fix bg9 b-radius2">
      <section class="f-flex pad7-1">
        <div class="sear-bb ">
          <div class=" new-search ns clearfix">
            <section class="sear-c red posi2 clearfix">
              <form
                action=""
                class="input-search-form"
              >
                <!-- <input
                  type="search"
                  input
                  autocomplete="off"
                  placeholder="输入关键字搜索"
                  ng-model="search.text"
                  class="f2 "
                > -->
                <van-search
                  shape="round"
                  v-model="searchVal"
                  placeholder="请输入搜索关键词"
                  background="transparent"
                  @search="handleSearch"
                />

              </form>
            </section>
          </div>
        </div>
      </section>
    </div>
    <div class="main-container mar4-1 clearfix">
      <section class="pad5-9 h-3 bg9">
        <div class="tab-box4">
          <span
            class="c-p"
            @click="flag=1"
            :class="flag==1?'active':''"
          >推荐</span>
          <span
            class="c-p"
            @click="flag=2"
            :class="flag==2?'active':''"
          >产品</span>
          <span
            class="c-p"
            @click="flag=3"
            :class="flag==3?'active':''"
          >营销活动</span>
        </div>
      </section>
      <section class="pad5-6 mar3-10">
        <div class="b-sh6 pad5">
          <ul>
            <li class="f2 c5 lin-h30 mess"><span class="c8 o-p4">1.</span>中英人寿如意年金保险费率更改说明。<span class="f-right c4">09-01</span></li>
            <li class="f2 c5 lin-h30 mess"><span class="c8 o-p">2.</span>中英人寿如意年金保险费率更改说明。<span class="f-right c4">09-01</span></li>
            <li class="f2 c5 lin-h30 mess"><span class="c8 o-p2">3.</span>中英人寿如意年金保险费率更改说明。<span class="f-right c4">09-01</span></li>
            <li class="f2 c5 lin-h30 mess"><span class="c8 o-p3">4.</span>中英人寿如意年金保险费率更改说明。<span class="f-right c4">09-01</span></li>
            <li class="f2 c5 lin-h30 mess"><span class="">5.</span>中英人寿如意年金保险费率更改说明。<span class="f-right c4">09-01</span></li>
          </ul>
        </div>
      </section>
      <div class="pad1-3">
        <h3 class="ek-com-tit f3-1">营销活动</h3>
        <div class="clearfix">
          <div
            class="blk1 f-left"
            style="width:52.69%;"
          ><img src="../../assets/img/my/a1.png"></div>
          <div
            class="blk2 f-right"
            style="width:43.8%;"
          ><img src="../../assets/img/my/a2.png"></div>
          <div
            class="blk3 f-right mar3"
            style="width:43.8%;"
            @click="$router.push({path:'/marketactivity'})"
          ><img src="../../assets/img/my/a3.png"></div>
        </div>
        <h3 class="ek-com-tit f3-1">产品列表</h3>
        <div class="b-sh1 ">
          <div class="fun-pro1 border-b1">
            <!-- 推荐 -->
            <van-tabs @click="changecl">
              <van-tab
                v-for="item in productTagList"
                :title="item.tagName"
                :key="item.id"
              >
              </van-tab>
            </van-tabs>
          </div>
          <section class=" pad6 b-radius1">
            <section class="blk-cont2020">
              <ul class="cont-blk  icon-wrap ">
                <!-- <van-list
                  v-model="loading"
                  :finished="finished"
                  :immediate-check="false"
                  finished-text="没有更多了"
                  @load="onLoad"
                  :offset="10"
                > -->
                <li
                  class="li-p2  posi2 clearfix"
                  v-for="(item,index) in productLists"
                  :key="index"
                  @click="goProductDetail(item)"
                >
                  <div class="product2020 f-left posi2">
                    <img
                      class="lazy-p"
                      :src="item.logoPath"
                      alt="pic"
                    >
                    <span class="state"><i class="t1"></i>网销</span>
                  </div>
                  <div class="info-blk  ">
                    <h3 class=" mess f3 c44 ">{{item.productName}}</h3>
                    <p
                      class="f1  mar444 mess"
                      v-if="item.feature"
                    >{{item.feature}}</p>
                    <div class="t-left mar444">
                      <span
                        class="type2020 ts"
                        v-if="item.tags.indexOf('recommend') !== -1"
                      >推荐</span>
                      <span
                        class="type2020 hot"
                        v-if="item.tags.indexOf('hot') !== -1"
                      >热销</span>
                    </div>
                    <div class="f2-1 c9 sub-info clearfix">
                      <span>{{item.prem + '￥起'}}</span>
                    </div>
                  </div>
                </li>
                <!-- </van-list> -->
              </ul>
            </section>
            <div
              class="f2 pad888"
              v-if="productLists.length>=total && productLists.length>0"
            >
              <div class="lzg-h-more posi2 t-center">
                <span class="c5 bg7 posi2 c222">没有更多啦</span>
              </div>
            </div>
          </section>
        </div>
      </div>
    </div>
  </div>
</template>

<script>
import Vue from 'vue'
import { mapGetters } from 'vuex'
import { api_my } from '@/api/index';
import * as tool from '@/common/Tool'
import { Tab, Tabs, Popup, Search, List, Empty } from 'vant';
import * as scroll from '@/common/Scroll'
import DataSource from '@/common/DataSource'
Vue.use(Tab);
Vue.use(Empty);
Vue.use(List);
Vue.use(Tabs);
Vue.use(Search)
Vue.use(Popup)
export default {
  name: 'marketing',
  data() {
    return {
      flag: 1,
      type: 1,
      offset: 0,
      limit: 10,
      total: 0,
      searchVal: '',
      productTagList: [],
      productLists: [],
      tagIndex: 0,
      promoteLinks: '',
      isLoad: true,
      allLoaded: false,
      queryLoading: true,
      promoteLinks: '',
      messPath: DataSource.get('messPath', 2) || ''
    }
  },
  computed: {
    ...mapGetters(['user'])
  },
  beforeCreate: function () {
    document.getElementsByTagName("body")[0].className = "bg3";
  },
  created() {
    this.productTag();
    this.productList();
    // this.articleList();
  },
  mounted() {
    window.addEventListener('scroll', this.handleScroll)
  },
  methods: {
    goBack() {
      this.$router.go(-1)
    },
    changecl(val) {
      this.tagIndex = this.productTagList[val].innerCode
      this.offset = 0
      this.productList();
    },

    productTag() {
      const data = {
        saasId: this.user.saasId,
        tagType: 'filter',
        dataStructure: 'tree'
      }
      api_my.productTag(data).then(res => {
        if (res.status == tool.rtCode.status) {
          let jason = {
            id: '0',
            innerCode: '0',
            tagName: '全部'
          }
          let newArry = []
          newArry.push(jason)
          this.productTagList = newArry.concat(res.productTagList)
        } else {
          tool.toastMessage(res.message, 'error')
        }
      })
    },
    productList() {
      const data = {
        saasId: this.user.saasId,
        mainRiskFlag: '1',
        channelDeptCode: '1000091',
        tagInnerCodes: this.tagIndex && this.tagIndex != '0' ? new Array(this.tagIndex) : [],
        params: {
          offset: this.offset,
          limit: this.limit
        },
        // search: this.searchVal,
      }
      api_my.productList(data).then(res => {
        if (res.status == tool.rtCode.status) {
          this.isLoad = false
          this.total = data.total
          if (this.offset === 0 || this.productLists.length === 0) {
            this.productLists = res.productList ? res.productList : []
            if (this.productLists.length < this.total) {
              this.queryLoading = false
            }
          } else {
            this.productLists = this.productLists.concat(res.productList)
          }
          this.allLoaded = this.productLists.length >= this.total
          if (this.allLoaded) {
            this.queryLoading = true
          }
        } else {
          tool.toastMessage(data.message, 'error')
        }
      })
    },
    handleSearch() {
      this.productLists = [];
      this.productList();
    },
    handleScroll() {
      if (scroll.getScrollTop() + scroll.getClientHeight() > (scroll.getScrollHeight() - 5)) {
        console.log(3);
        this.loadMore()
      }
    },
    loadMore() {
      // if (this.queryLoading) {
      //   console.log(1);
      //   return
      // }
      if (!this.isLoad) {
        this.isLoad = true
        this.offset += 10
        this.productList()
      }
    },
    goProductDetail(item) {
      const channelUserId = this.user.userInfo.mobile || this.user.userInfo.agentcode,
        identificationStatus = this.user.userInfo.status,
        timer = new Date().getTime(),
        curridProvince = this.user.userInfo.province || ''
      if (item.productType == '13' && identificationStatus === 2) {
        this.promoteLinks = item.staticPage + '&userId=' + this.user.userInfo.userId
      } else {
        this.promoteLinks = tool.app.lzgUrl + '#/channel/channelCode=' + tool.app.platformCode + '&channelUserId=' + channelUserId + '&productId=' + item.briskCode + '&opType=1&areaCode=' + curridProvince + '&shareTime=' + timer + '&status=' + identificationStatus
      }
      if (this.messPath && this.messPath === 'messWindow') {
        DataSource.set('sendProductMess', this.promoteLinks, 2)
        this.$router.go(-1)
      } else {
        window.location.href = this.promoteLinks
      }
    },
  },
  beforeDestroy: function () {
    DataSource.del('messPath', 2)
    document.body.removeAttribute("class", "bg3")
  },
  destroyed() {
    window.removeEventListener('scroll', this.handleScroll)
  }
}
</script>

<style scoped>
.van-search {
  padding: 0;
}
.van-search__content {
  background-color: transparent;
}
</style>