<template>
  <div class="t-center">
    <input :id="uploadFileId" type="file" :disabled="upDisable" class="fileLoad" style="z-index:11;" accept="image/gif,image/jpeg,image/jpg,image/png,image/svg" @change="upLoad">
  </div>
</template>

<script>
  let COS = require('cos-js-sdk-v5')
  import { api_system } from '@/api/index'
  import * as tool from '@/common/Tool'

  export default {
    name: "UploadFile",
    data () {
      return {
        fileArr: Object,
        uploadFileId: this.uploadId || 'uploadId'
      }
    },
    props: {
      upDisable: Boolean,
      uploadId: String,
      uploadOcr: String
    },
    methods: {
      upLoad () {
        console.log(this.fileArr)
        let fileObj = document.getElementById(this.uploadFileId).files[0]
        let blobFile = this.$options.methods.dataURLtoBlob.bind(this)(fileObj)
        let filename = fileObj.name
        this.$options.methods.uploadFile.bind(this)(blobFile, filename)
      },
      //上传腾讯云
      uploadFile (file, filename) {
        const bucket = tool.cos.bucketName //tool.globalData.bucket
        // const appid = tool.cos.appid
        const region = tool.cos.region
        const folder = tool.cos.folder
        const uuid = tool.getUUID()
        const _that = this

        const cos = new COS({
          getAuthorization: function (options, callback) {
            api_system.cosGetSign({type: ''})
              .then(data => {
                callback({
                  TmpSecretId: data.tmpSecretId,
                  TmpSecretKey: data.tmpSecretKey,
                  XCosSecurityToken: data.token,
                  // 建议返回服务器时间作为签名的开始时间，避免用户浏览器本地时间偏差过大导致签名错误
                  StartTime: data.startTime, // 单位是秒
                  ExpiredTime: data.expiredTime,
                  ScopeLimit: true // 细粒度控制权限需要设为 true，会限制密钥只在相同请求时重复使用
                })
              })
          }
        })
        cos.putObject({
          Bucket: bucket, /* 必须 */
          Region: region, /* 存储桶所在地域，必须字段 */
          Key: folder + uuid + filename, /* 必须 */
          StorageClass: 'STANDARD',
          Body: file, // 上传文件对象
          onProgress: function(progressData) {
            console.log(JSON.stringify(progressData))
          }
        }, function(err, data) {
          console.log(err || data)
          console.log(data)
          if(data.statusCode == '200'){
            _that.fileArr = {'enclosureName': filename, 'url': 'https://' + data.Location, 'id': _that.uploadFileId}
            _that.$emit('iptFile', _that.fileArr)
            tool.toastMessage('恭喜,上传成功！')
            if (_that.uploadOcr) {
              console.log('OCR识别')
              const _data = {
                ocrtype: _that.uploadOcr,
                cosPath: _that.fileArr.url
              }
              api_system.imageOCR(_data).then(res => {
                if (res.status == tool.rtCode.status) {
                  if (_that.uploadOCR == '1') { //身份证识别
                    _that.fileArr.ocrData = res.idCard
                  } else if (_that.uploadOCR == '3') { //银行卡识别
                    _that.fileArr.ocrData = res.bankCard
                  }
                  _that.$emit('ocrFun', _that.fileArr)
                }
              })
            }
          } else {
            tool.toastMessage('请求失败', 'error')
          }
        })
      },
      //DataURL转Blob
      dataURLtoBlob(fileObj) {
        console.log(fileObj.size)
        return new Blob([fileObj], { type: fileObj.type })
      },
    }
  }
</script>

<style scoped>
  .fileBox{display: inline-block; width: 70px;position: absolute;overflow: hidden;right:0;}
  .file-ip{position: absolute; z-index: 1; top: 0; right: 0; bottom: 0; left: 0;opacity: 0; width:100%; height:100%;}
</style>

