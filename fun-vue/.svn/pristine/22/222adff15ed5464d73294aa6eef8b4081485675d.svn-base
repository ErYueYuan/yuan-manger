<template>
  <div class="bg7">
    <!--<div class="main-container mar2  no-bot clearfix ">-->
    <!--<div class="login-box clearfix">-->
    <!--<div class=" f8 c1 ">欢迎登录e管家<br>-->
    <!--</div>-->
    <!--<div class="t-center c2">-->
    <!--<button type="button"  @click.stop.prevent="handleSubmit">登录</button>-->
    <!--</div>-->
    <!--</div>-->
    <!--</div>-->
    <div class="fun-top-panel bg7 border-b1 ">
      <span class="mess-back "><div class="cont"></div></span>
      <span class="title c33 f4 dblock2 t-center ">登录</span>
    </div>
    <div class="main-container no-bot clearfix ">
      <div class="login-box clearfix">
        <div class="log-logo" title="logo"><img src="@/assets/img/logo.png"/></div>
        <section class="login-info-box">
          <div class="login-input mar29 ">
            <span class="f3 c5">手机号码</span>
            <input placeholder="请输入工号或手机号" id="username" class="f3-1" type="text" v-model="loginCredential.username">
          </div>
          <div class="login-input posi2">
            <span class="f3 c5">密码</span>
            <input placeholder="请输入密码" id="password" class="f3-1" type="password" v-model="loginCredential.password">
            <div class="hidden c-p" title="隐藏"></div>
            <div class="show-it c-p" title="显示"></div>
          </div>
        </section>
        <div class="f1 t-right c4">忘记密码？<span class="c111 c-p" @click="$router.push({path: '/resetPwd'})">找回密码</span>
        </div>

      </div>
      <div class="pad5-1">
        <button type="button" class="hx-bt3 t-center" @click.stop.prevent="handleSubmit">登录</button>
        <div class="f1 t-center c4 mar2">没有账号？<span class="c111 c-p"
                                                    @click="$router.push({path: '/register'})">去注册</span></div>
      </div>
    </div>
  </div>
</template>

<script>
  // @ is an alias to /src
  import { api_user } from '@/api/index'
  import DataSource from '@/common/DataSource'
  import * as tool from '@/common/Tool'
  import Vd from '@/common/Validator'

  export default {
    name: 'login',
    data() {
      return {
        loginCredential: {
          username: '',
          password: '',
        },
        openid: this.$route.query.openid ? this.$route.query.openid : '',
      }
    },
    methods: {
      handleSubmit() {
        if (Vd.required(this.loginCredential.username, '请输入用户账号')
          && Vd.required(this.loginCredential.password, '请输入密码')
          && Vd.password(this.loginCredential.password, '请输入正确格式密码')) {
          if (tool.globalData.isWeiXin) {
            api_user.bindWx({
              openid: this.openid,
              platformCode: tool.app.platformCode,  // 平台编号
              saasId: tool.app.saasId, // 服务商编号
              code: this.loginCredential.username,
              password: this.loginCredential.password,
              imeiType: tool.globalData.isIOS || tool.globalData.isWxIOS ? '1' : '0', // 0-android，1-ios
              userAgent: window.navigator.userAgent.toLowerCase()
            })
              .then(res => {
                if (res.status == tool.rtCode.status) {
                  tool.toastMessage('绑定成功')
                  DataSource.set('userInfo', res, 1)
                  DataSource.set('token', res.token, 1)
                  tool.setUser(res)
                  this.$router.push({ path: '/home' })
                } else {
                  tool.toastMessage(res.message, 'error')
                }
              })
          } else {
            api_user.login({
              platformCode: tool.app.platformCode,  // 平台编号
              saasId: tool.app.saasId, // 服务商编号
              code: this.loginCredential.username,
              password: this.loginCredential.password,
              imeiType: tool.globalData.isIOS || tool.globalData.isWxIOS ? '1' : '0', // 0-android，1-ios
              userAgent: window.navigator.userAgent.toLowerCase()
            })
              .then(res => {
                if (res.status == tool.rtCode.status) {
                  tool.toastMessage('登录成功')
                  DataSource.set('userInfo', res, 1)
                  DataSource.set('token', res.token, 1)
                  tool.setUser(res)
                  this.$router.push({ path: '/home' })
                } else {
                  tool.toastMessage(res.message, 'error')
                }
              })
          }
        }
      }
    }
  }
</script>

