<template>
  <div>
    <top-panel :topPanel="topPanel"></top-panel>
    <div class="main-container mar3-7 clearfix">
      <section class="bg7 mar3 b-radius3">
        <div class="pad1-3" v-for="(item, index) in systemNewsList" :key="index" @click="goNewsDetail(item)">
          <h3 class="ek-com-tit40 tri c-p f2 c6 ">王佳佳<span class="pad4-3">预约服务人员了解产品，请尽快跟进</span></h3>
          <p class="f1 c5">来源：计划书《信泰如意尊家庭计划》</p>
          <p class="f1 c5">当前录入节点：<span class="c333">保险计划</span></p>
          <div class="t-right c4 f1 lin-h30 border-b1">2020-08-17  13:45</div>
        </div>
        <van-empty v-if="systemNewsList.length === 0" description="暂无消息" />
      </section>
    </div>
  </div>
</template>

<script>
  import Vue from 'vue'
  import { mapGetters } from 'vuex'
  import { TopPanel } from '@/components/index'
  import * as tool from '@/common/Tool'
  import { api_mess } from '@/api/index'
  import * as scroll from '@/common/Scroll'
  import { Empty } from 'vant'

  Vue.use(Empty)

  export default {
    name: "SystemNews",
    data () {
      return {
        sourceChannel: tool.globalData,
        topPanel: {
          back: true,
          titles: "系统消息",
        },
        scrollId: '',
        total: '',
        systemNewsList: [],
        limit: tool.pagination.pagesize,
        offset: tool.pagination.pageoffset,
        isLoad: true,
        allLoaded: false,
        queryLoading: true,
      }
    },
    components: {
      'top-panel': TopPanel,
    },
    computed: {
      ...mapGetters(['user']),
    },
    beforeCreate: function() {
      document.getElementsByTagName("body")[0].className = "bg3";
    },
    created () {
      this.getSystemList()
    },
    mounted () {
      window.addEventListener('scroll', this.handleScroll)
    },
    methods: {
      getSystemList () {
        const _data = {
          params :
            {
              scrollId: this.scrollId,
              totalCount: this.total + '',
              limit: this.limit,
              offset: this.offset,
              messageType: '0', //消息系统-2
              messageStatus: '0', //0-未读，1-已读
              messageTo: this.user.userInfo.agentcode,
              saasId: tool.app.saasId,
              messageReciveClient: 1, //终端类型：0-微信，1-app(站内信),2-PC,3-短信,4-邮箱
              platformCode: tool.app.platformCode //平台编码
            }
        }
        api_mess.getSystemNewsList(_data).then(data => {
          if (data.status === tool.rtCode.status) {
            this.isLoad = false
            this.total = data.total
            this.scrollId = data.scrollId
            if (data.mhMessageLogInfos && data.mhMessageLogInfos.length > 0) {
              for (let it of data.mhMessageLogInfos) {
                it.createdate = new Date(Date.parse(it.createdate.replace(/-/g, "/")))
              }
            }
            if (this.offset == 0 || this.meetList.length == 0) {
              this.systemNewsList = data.mhMessageLogInfos
              if (this.systemNewsList.length < this.total) {
                this.queryLoading = false
              }
            } else {
              this.systemNewsList = this.systemNewsList.concat(data.mhMessageLogInfos)
            }
            this.allLoaded = this.systemNewsList.length >= data.total
            if (this.allLoaded) {
              this.queryLoading = true
            }
          } else {
            tool.toastMessage(data.message, 'error')
          }
        })
      },
      loadMore() {
        if (this.queryLoading) {
          return
        }
        if (!this.isLoad) {
          this.isLoad = true
          this.offset += 10
          this.getSystemList()
        }
      },
      handleScroll() {
        if (scroll.getScrollTop() + scroll.getClientHeight() > (scroll.getScrollHeight() - 5)) {
          this.loadMore()
        }
      },
      goNewsDetail (it) {
        this.$router.push({path: '/insureNewsInfo/5'})
      }
    },
    beforeDestroy: function() {
      document.body.removeAttribute("class", "bg3")
    },
    destroyed() {
      window.removeEventListener('scroll', this.handleScroll)
    }
  }
</script>

<style scoped>

</style>
