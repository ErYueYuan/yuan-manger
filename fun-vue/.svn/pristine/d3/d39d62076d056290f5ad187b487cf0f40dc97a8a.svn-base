<template>
  <div class="bg3">
    <div class="fun-top-panel bg9">
      <span
        class="mess-back "
        @click="goBack()"
      >
        <div class="cont-wh"></div>
      </span>
      <span class="title c7 f3 dblock2 t-center">营销政策</span>
    </div>
    <div class="main-top p-fix bg9 b-radius2">
      <section class="f-flex pad7-1">
        <div class="sear-bb ">
          <div class=" new-search ns clearfix">
            <section class="sear-c red posi2 clearfix">
              <form
                action=""
                class="input-search-form"
              >
                <van-search
                  shape="round"
                  v-model="searchVal"
                  placeholder="请输入搜索关键词"
                  background="transparent"
                  @search="handleSearch"
                />
              </form>
            </section>
          </div>
        </div>
      </section>
    </div>
    <div class="main-container mar4-1 clearfix">
      <section class="pad5-9 h-3 bg9">
        <div class="tab-box4">
          <span
            v-for="item in articltag"
            :key="item.id"
            class="c-p"
            @click="tagclick(item.id)"
            :class="flag==item.id?'active':''"
          >{{item.groupName}}</span>
        </div>
      </section>
      <section class="pad5-6 mar3-10 main-container clearfix" >
        <div class="b-sh6 pad5 " style="max-height:230px;overflow:auto;">
          <ul>
            <li
              class="f2 c5 lin-h30 mess"
              v-for="(item,index) in articleLists"
              :key="index"
              @click="aricle(item)"
            ><span class="c8 o-p4">{{index+1}}.</span>{{item.title}}<span class="f-right c4">{{item.createTime | dataFormat('MM-dd')}}</span></li>
          </ul>
        </div>
      </section>
      <div class="pad1-3">
        <h3 class="ek-com-tit f3-1">营销活动</h3>
        <div class="clearfix">
          <div
            class="blk3  mar3"
            style="width:80%;margin:0 auto;"
            @click="$router.push({name:'marketactivity'})"
          ><img src="../../assets/img/my/a3.png" style="height:74px;"></div>
        </div>
        <h3 class="ek-com-tit f3-1">产品列表</h3>
        <div class="b-sh1 ">
          <div class="fun-pro1 border-b1">
            <!-- 推荐 -->
            <van-tabs @click="changecl">
              <van-tab
                v-for="item in productTagList"
                :title="item.tagName"
                :key="item.id"
              >
              </van-tab>
            </van-tabs>
          </div>
          <section class=" pad6 b-radius1">
            <section class="blk-cont2020">
              <ul class="cont-blk  icon-wrap ">

                <li
                  class="li-p2  posi2 clearfix"
                  v-for="(item,index) in productLists"
                  :key="index"
                  @click="goProductDetail(item)"
                >
                  <div class="product2020 f-left posi2">
                    <img
                      class="lazy-p"
                      :src="item.logoPath"
                      alt="pic"
                    >
                    <span class="state"><i class="t1"></i>网销</span>
                  </div>
                  <div class="info-blk  ">
                    <h3 class=" mess f3 c44 ">{{item.productName}}</h3>
                    <p
                      class="f1  mar444 mess"
                      v-if="item.feature"
                    >{{item.feature}}</p>
                    <div class="t-left mar444">
                      <span
                        class="type2020 ts"
                        v-if="item.tags?item.tags.indexOf('recommend') !== -1:''"
                      >推荐</span>
                      <span
                        class="type2020 hot"
                        v-if="item.tags?item.tags.indexOf('hot') !== -1:''"
                      >热销</span>
                    </div>
                    <div class="f2-1 c9 sub-info clearfix">
                      <span>{{item.prem + '￥起'}}</span>
                    </div>
                  </div>
                </li>

              </ul>
              <div
              class="f2 pad888"
              v-if="productLists.length>=total && productLists.length>0"
            >
              <div class="lzg-h-more posi2 t-center">
                <span class="c5 bg7 posi2 c222">没有更多啦</span>
              </div>
            </div>
            </section>
          </section>
        </div>
      </div>
    </div>
  </div>
</template>

<script>
import Vue from 'vue'
import { mapGetters } from 'vuex'
import { api_my } from '@/api/index';
import * as tool from '@/common/Tool'
import { Tab, Tabs, Popup, Search, List, Empty } from 'vant';
import * as scroll from '@/common/Scroll'
import DataSource from '@/common/DataSource'
Vue.use(Tab);
Vue.use(Empty);
Vue.use(List);
Vue.use(Tabs);
Vue.use(Search)
Vue.use(Popup)
export default {
  name: 'marketing',
  data() {
    return {
      flag: 36,
      type: 1,
      offset: 0,
      limit: 10,
      total: 0,
      searchVal: '',
      productTagList: [],
      productLists: [],
      tagIndex: 0,
      promoteLinks: '',
      isLoad: true,
      allLoaded: false,
      queryLoading: true,
      promoteLinks: '',
      messPath: DataSource.get('messPath', 2) || '',
      articltag: [],
      articleLists: []
    }
  },
  computed: {
    ...mapGetters(['user'])
  },
  beforeCreate: function () {
    document.getElementsByTagName("body")[0].className = "bg3";
  },
  created() {
    this.productTag();
    this.productList();
    this.getarticleList();
    this.listOneLevel();
  },
  mounted() {
    window.addEventListener('scroll', this.handleScroll)
  },
  methods: {
    goBack() {
      this.$router.go(-1)
    },
    changecl(val) {
      this.tagIndex = this.productTagList[val].innerCode
      this.offset = 0
      this.productList();
    },
    productTag() {
      const data = {
        saasId: this.user.saasId,
        tagType: 'filter',
        dataStructure: 'tree'
      }
      api_my.productTag(data).then(res => {
        if (res.status == tool.rtCode.status) {
          let jason = {
            id: '0',
            innerCode: '0',
            tagName: '全部'
          }
          let newArry = []
          newArry.push(jason)
          this.productTagList = newArry.concat(res.productTagList)
        } else {
          tool.toastMessage(res.message, 'error')
        }
      })
    },
    productList() {
      const data = {
        saasId: tool.app.saasId,
        mainRiskFlag: '1',
        channelDeptCode: '1000091',
        tagInnerCodes: this.tagIndex && this.tagIndex != '0' ? new Array(this.tagIndex) : [],
        params: {
          offset: this.offset,
          limit: this.limit
        },
        search: this.searchVal
      }
      api_my.productList(data).then(res => {
        if (res.status == tool.rtCode.status) {
          this.isLoad = false
          this.total = res.total
          if (this.offset == 0 || this.productLists.length == 0) {
            this.productLists = res.productList ? res.productList : []
            if (this.productLists.length < this.total) {
              this.queryLoading = false
            }
          } else {
            this.productLists = this.productLists.concat(res.productList)
          }
          console.log(this.productLists.length,this.total);
          this.allLoaded = this.productLists.length >= this.total
          console.log(this.allLoaded);
          if (this.allLoaded) {
            console.log('allLoaded');
            this.queryLoading = true
          }
        } else {
          tool.toastMessage(data.message, 'error')
        }
      })
    },
    handleSearch() {
      this.productLists = [];
      this.productList();
    },
    handleScroll() {
      if (scroll.getScrollTop() + scroll.getClientHeight() > (scroll.getScrollHeight() - 5)) {
        console.log(3);
        this.loadMore()
      }
    },
    loadMore() {
      if (this.queryLoading) {
        return
      }
      if (!this.isLoad) {
        this.isLoad = true
        this.offset += 10
        this.productList()
      }
    },
    goProductDetail(item) {
      const channelUserId = this.user.userInfo.mobile || this.user.userInfo.agentcode,
        identificationStatus = this.user.userInfo.status,
        timer = new Date().getTime(),
        curridProvince = this.user.userInfo.province || ''
      if (item.productType == '13' && identificationStatus === 2) {
        this.promoteLinks = item.staticPage + '&userId=' + this.user.userInfo.userId
      } else {
        this.promoteLinks = tool.app.lzgUrl + '#/channel/channelCode=' + tool.app.platformCode + '&channelUserId=' + channelUserId + '&productId=' + item.productCode+ '&briskCode=' + item.briskCode + '&opType=1&areaCode=' + curridProvince + '&shareTime=' + timer + '&status=' + identificationStatus + '&platformId=2724341dfdc5463cbf167f1195da6e3e&platformCode=12'
      }
      if (this.messPath && this.messPath === 'messWindow') {
        DataSource.set('sendProductMess', this.promoteLinks, 2)
        this.$router.go(-1)
      } else {
        window.location.href = this.promoteLinks
      }
    },
    listOneLevel() {
      let _data = {
        "params": {
          "groupName": "营销政策",
          "groupType": "article",
          "saasId": "ff5a67337b6611e89feafa163eb3e537",
          "platformId": "2724341dfdc5463cbf167f1195da6e3e"
        }
      }
      api_my.listOneLevel(_data).then(res => {
        if (res.status == tool.rtCode.status) {
          this.infoParentId(res.lmGroupList[0].id)
        } else {
          tool.toastMessage(res.message, 'error')
        }
      })
    },
    infoParentId(item) {
      let _data = {
        parentId: item
      }
      api_my.infoParentId(_data).then(res => {
        console.log(res);
        if (res.status == tool.rtCode.status) {
          this.articltag = res.lmGroupList
        } else {
          tool.toastMessage(data.message, 'error')
        }
      })
    },
    tagclick(val) {
      this.flag = val
      this.getarticleList();
    },
    getarticleList() {
      let _data = {
        "params": {
          id: this.flag,
          "showDeptCode": "1000000",
          "saasId": "ff5a67337b6611e89feafa163eb3e537",
          "platformId": "2724341dfdc5463cbf167f1195da6e3e"
        }
      }
      api_my.articleList(_data).then(res => {
        if (res.status == tool.rtCode.status) {
          this.articleLists = res.articleList
        } else {
          tool.toastMessage(res.message, "error");
        }
      })
    },
    aricle(item){
       this.$router.push({name: "articleDetail", params: {id: item.id}});
    }
  },
  beforeDestroy: function () {
    DataSource.del('messPath', 2)
    document.body.removeAttribute("class", "bg3")
  },
  destroyed() {
    window.removeEventListener('scroll', this.handleScroll)
  }
}
</script>

<style scoped>
.van-search {
  padding: 0;
}
.van-search__content {
  background-color: transparent;
}
</style>
