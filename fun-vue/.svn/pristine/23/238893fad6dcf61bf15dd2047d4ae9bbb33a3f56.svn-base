<template>
  <div>
    <div class="ek-top-panel bg4">
      <top-panel :topPanel="topPanel" v-if="!sourceChannel.isWeiXin"></top-panel>
      <div class="main-container clearfix" :class="!sourceChannel.isWeiXin?'mar1':''">
        <section class="pad5 e-article-box">
          <div class>
            <h3 class="f7">{{info.title}}</h3>
            <sub class="f2 clearfix c4">
              作者：{{info.authorname}}
              <span class="f-right">{{info.publishDate}}</span>
            </sub>
          </div>
          <div class="f3" v-html="info.text"></div>
        </section>
      </div>
    </div>
    <div class="e-arti-bot posi1">
      <div class="row">
        <div class="col-2 c-p">
          <b class="b1"></b>
          <p class="f1 t-center c5">观看{{info.readCount}}</p>
        </div>
        <div class="col-8 c-p"></div>
        <!-- <div class="col-2">
       <b class="fav on"></b> on 开关
       <p class="f1 t-center c5">点赞</p>
        </div>-->
        <div class="col-2 c-p" @click="goShare()">
          <b class="share"></b>
          <p class="f1 t-center c5">分享</p>
        </div>
      </div>
    </div>
    <div class="share-sign" v-if="shareMask">
      <img src="@/assets/img/share2.png"/>
    </div>
  </div>
</template>

<script>
  import { api_article } from '@/api/index'
  import * as tool from '@/common/Tool'
  import { mapGetters } from 'vuex'
  import { TopPanel } from '@/components/index'
  import wxApi from '@/assets/js/wxapi.js'
  import DataSource from '@/common/DataSource'

  export default {
    name: 'ArticleDetail',
    data() {
      return {
        sourceChannel: tool.globalData,
        shareMask: false,
        topPanel: {
          back: true,
          titles: '文章详情',
        },
        id: this.$route.params.id,
        info: '',
        isShare: '',
        timer: '',
        backtrace_id: '' // 阅读时唯一id
      }
    },
    computed: {
      ...mapGetters(['user']),
    },
    components: {
      'top-panel': TopPanel,
    },
    created() {
      this.backtrace_id = tool.getUUID()
      if (DataSource.get('wxInfo', 2)) { //说明是分享进入
        this.isShare = 'Y'
      }
      this.getDetail(this.id)
    },
    methods: {
      getDetail(id) {
        var _data = {
          saasId: tool.app.saasId,
          id: id,
          platformId: tool.app.platformId,
        }
        api_article.getArticleDetail(_data).then((res) => {
          if (res.status == tool.rtCode.status) {
            let _that = this
            this.info = res.articleDetail
            if (this.isShare == 'Y') {
              _that.shareRead()
            }
          }
        })
      },
      goShare() {
        if (tool.globalData.isWeiXin) {
          this.shareManager(this.id)
        } else {
          tool.toastMessage('网页端暂不支持分享', 'error')
        }
      },
      shareManager(id) {
        let that = this
        let _uuid = tool.getUUID()
        let params = {
          'share_uuid': _uuid, //分享uuid
          'shareEvent_code': 'articleDetailShare',//事件编码
          'shareUrl': window.location.href.split('/funzg')[0] + '/funzg/wx/articleDetail-' + this.user.userInfo.userId + '-' + id,
          'share_userId': this.user.userInfo && this.user.userInfo.userId,//分享人id
          'share_user_code': this.user.userInfo && this.user.userInfo.agentcode,
          'share_userName': this.user.userInfo && this.user.userInfo.name,//分享人名称
          'platformCode': tool.app.sourceFlag,
          'share_businessId': id,//分享内容编码
          'share_businessName': that.info.title || '' //分享内容名称
        }
        let paramsJson = tool.cloneObject(params)
        delete paramsJson.shareUrl  //有url会出错
        this.$logVisit.putShareInfo(params) // 日志插入
        let option = {
          title: that.info.title,
          link: window.location.href.split('/funzg')[0] + '/funzg/wx/articleDetail-' + this.user.userInfo.userId + '-' + id + '-' + JSON.stringify(paramsJson),
          imgUrl: that.info.coverImage,
          desc: that.info.simple || '文章描述~'
        }
        wxApi.wxShare(option)
        that.maskTip()
      },
      shareRead() {
        let _that = this
        let wxInfo = DataSource.get('wxInfo', 2)
        let nowTime = new Date().getTime()
        let params = {
          'backtrace_id': this.backtrace_id,
          'share_uuid': wxInfo.params.share_uuid,//分享uuid
          'event_code': wxInfo.params.shareEvent_code,//事件编码
          'shareUrl': '',
          'share_user_id': wxInfo.params.share_userId, //分享人id
          'share_user_code': wxInfo.params.share_user_code,
          'share_businessId': wxInfo.params.share_businessId,
          'share_businessName': wxInfo.params.share_businessName,
          'platformCode': wxInfo.params.platformCode,
          'openid': wxInfo.openid, //阅读人openid
          'nickname': wxInfo.userInfo.name,//阅读人昵称
          'sex': wxInfo.userInfo.sex,//阅读人性别
          'head_image_url': wxInfo.head,//阅读人头像
          'readTime': nowTime,
          'client_flag': ''  //是否是渠道客户:N-否;Y-是'
        }
        this.$logVisit.putShareReadInfo(params)
        this.timer = setTimeout(function () {
          _that.shareRead()
        }, 30000)
      },
      maskTip() {
        this.shareMask = true
        setTimeout(() => {
          this.shareMask = false
        }, 5000)
      },
    },
    beforeRouteLeave(to, from, next) {
      if (to.name == 'articleList') {
        if (!to.meta.keepAlive) {
          to.meta.keepAlive = true
        }
      } else {
        to.meta.keepAlive = false
        this.$destroy()
      }
      next()
    },
    beforeDestroy: function () {
      if (this.timer) {
        clearInterval(this.timer)
      }
    },
  }
</script>

<style scoped>

</style>
