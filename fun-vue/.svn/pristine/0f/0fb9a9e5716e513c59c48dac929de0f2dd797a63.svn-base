<template>
    <div class="bg7">
        <div class="fun-top-panel bg-my  ">
            <span class="mess-back " @click="goBack()"><div class="cont-wh"></div></span>
            <span class="title c7 f4 dblock2 t-center ">个人信息</span>
        </div>

        <div class="main-container mar1  clearfix">
            <div class="my-n-txtbox s-bg posi2">
                <div class="add-btn c7 t-center f1 c-p" style="border-radius: 6px 0 0 15px;" @click="addRecord()">新增跟进记录</div>
                <div class="top-one  clearfix" >
                    <div class=" pad3 right-box posi2 c7 " >
                        <h3 class=" f3 c-p"><span>{{nikeName}}</span>
                        </h3>
                        <div class="f2 c7 per-info mar3 ">
                            <b class="one"></b>来源：
                            <span v-if="getSource == 1">系统分配</span>
                            <span v-if="getSource == 2">主动取数</span>
                            <span v-if="getSource == 3">自建客户</span>
                            <span v-if="getSource == 4">成交客户</span>
                        </div>
                        <!-- <div class="f2 c7 per-info  ">
                            <b class="two"></b>客户号：CC0157941027
                        </div> -->
                        <div class="f2 c7 per-info  ">
                            <b class="three"></b>客户等级：
                            <span class="stars-box2" v-if="customerStar == 1"><i></i></span>
                            <span class="stars-box2" v-if="customerStar == 2"><i></i><i></i></span>
                            <span class="stars-box2" v-if="customerStar == 3"><i></i><i></i><i></i></span>
                            <span class="stars-box2" v-if="customerStar == 4"><i></i><i></i><i></i><i></i></span>
                            <span class="stars-box2" v-if="customerStar == 5"><i></i><i></i><i></i><i></i><i></i></span>
                        </div>
                    </div>
                    <div class="img-box  posi2">
                        <img v-if="!!sex && sex == 1" src="../../assets/img/szxx/me.png" />
                        <img v-if="!!sex && sex == 0" src="../../assets/img/szxx/dau.png" />
                    </div>
                </div>
            </div>

          <div class="posi2 mar3-5 bg7  bg7 b-radius1">
            <section class=" pad1-3  ">
                    <div id="proNav" class="swiper-container border-b1">
                        <div class="swiper-wrapper f-flex" style="overflow-x: scroll;">
                            <van-tabs title-active-color="#ee0a24" v-model="active" @click="handleClickTag">
                                <van-tab
                                    :scrollspy="true"
                                    v-for="(article, index) in tabList"
                                    :key="index"
                                    :title="article.tagName">
                                </van-tab>
                            </van-tabs>
                        </div>
                    </div>

                    <!-- 历史方案 -->
                    <div>
                        <section class="mar3-2">
                            <div class="b-sh1   bg7  mar7-3 "  v-for="(item,index) in proposalList" :key="index">
                                <section class="blk-cont2020  ">
                                    <div class="mar7">
                                        <ul class="cont-blk  icon-wrap ">
                                            <li class="li-p6  posi2 clearfix">
                                                <div class="product2020 f-left posi2">
                                                    <img class="lazy-p" src="item.ERiskPicRelaPath" alt="pic">
                                                </div>
                                                <div class="info-blk  ">
                                                    <h3 class=" mess f3 c44 ">{{item.riskName}}</h3>
                                                    <p>{{'被保人：' + (item.insuredsex == 1 ? '男' : '女') + '&nbsp;&nbsp;&nbsp;&nbsp;' + item.insuredage.slice(0,-1) + '周岁&nbsp;&nbsp;&nbsp;'}}</p>
                                                    <div class="t-left f2 c4 mar2">
                                                        编码: {{item.proposalNo}}
                                                    </div>
                                                    <div class="t-left c4 f2 ">
                                                        首期保费:<span class="c9">{{item.totalamount}}元</span>
                                                    </div>
                                                </div>
                                            </li>
                                        </ul>
                                        <div class="f-flex pad1 border-t" style="align-items: center;">
                                            <div class="f1-2 " style="color: #666;">{{item.createDate.slice(0,4)}}-{{item.createDate.slice(4,6)}}-{{item.createDate.slice(6)}}</div>
                                            <div class="t-right mar6-2 pad6-1 " v-show="totalCount!=0">
                                                <button class=" ek-btn-3 min-w f1 mar5-3"  @click="goProposalEdit(item.proposalId)">编辑</button>
                                                <button class=" ek-btn-3 min-w f1" @click="delProposal(item.proposalId)">删除</button>
                                            </div>
                                        </div>
                                        <van-empty v-show="totalCount===0" description="暂无历史方案" />
                                    </div>
                                </section>
                            </div>
                            <div class="f2 pad888" v-if="proposalList.length>=totalCount && proposalList.length>0">
                                <div class="lzg-h-more posi2 t-center">
                                    <span class="c5 bg7 posi2 c222">没有更多啦</span>
                                </div>
                            </div>
                        </section>
                    </div>

                </section>
            </div>
        </div>

        <div class="in-nav-bot posi1 " style="bottom: 0px;">
            <div class=" c-p "><b class="one"></b><p class="f1 t-center c6">客户沟通</p></div>
            <div class=" c-p pad0">
                <b class="two"></b><p class="f1 t-center c6">电话</p>
            </div>
            <div class=" c-p pad0">
                <b class="three"></b><p class="f1 t-center c6">制作方案</p>
            </div>
            <div class="bbtn t-right c-p">
                <span class="hx-bt3 bt1 f3 ">投保</span>
            </div>
        </div>

        <div class="mask-layer" style="z-index:23;" v-show="isDel"></div>
        <div class="pop-box" v-show="isDel">
            <h3 class="tit c6 f4 t-center"></h3>
            <div class="pad5-11 f2-1 c5 t-center">
                确定要删除此方案吗？
            </div>
            <div class="row mar0 border-t">
                <div class="col-6 t-center f4 c-p c5 pad6-1 border-r" @click="cancelDel()">取消</div>
                <div class="col-6 t-center f4 c-p c8 pad6-1" @click="confirmDel()">确定</div>
            </div>
        </div>

    </div>
</template>
<script>
    import Vue from 'vue'
    import { mapGetters } from 'vuex'
    import * as tool from '@/common/Tool'
    import { api_sell } from '@/api/index'
    import DataSource from '@/common/DataSource'
    import '@vant/touch-emulator'
    import { Tab, Tabs, Empty } from 'vant'
    import * as scroll from '@/common/Scroll'

    Vue.use(Tab)
    Vue.use(Tabs)
    Vue.use(Empty)

    export default {
        name: "historyList",
        data () {
            return {
                clientId: this.$route.params.q,//客户id
                clientNewId: this.$route.params.r,
                nikeName: "",
                sex: "",//1男，0女，2未知
                getSource: "",
                customerStar: "",
                cerCode: "",
                customerDetail: [],
                familyList: [],//家庭成员列表
                relation: 0,//家庭成员列表初始化展示项
                relationFlag: "01",
                otherInfo: true,
                funProductTagDTOList: [],//已购产品标签列表
                funProductDTOList: [],//已购产品列表
                productTag: 'B',//已购产品标签初始化展示项,B:寿险产品E:互助产品:F:理财产品
                funFollowUpDTOList: [],//跟进列表
                portraitTagsName: [],//客户画像里的标签
                portraitSex: "",
                portraitAge: "",
                addFriendsTime: "",
                interactNum: "",
                visitTime: "",
                funVisitTrailDTO: [],
                tabList: [
                    {
                        id: '0',
                        innerCode: '0',
                        tagName: '基本信息'
                    },
                    {
                        id: '1',
                        innerCode: '1',
                        tagName: '订单'
                    },
                    {
                        id: '2',
                        innerCode: '2',
                        tagName: '轨迹'
                    },
                    {
                        id: '3',
                        innerCode: '3',
                        tagName: '跟进'
                    },
                    {
                        id: '4',
                        innerCode: '4',
                        tagName: '历史方案'
                    },
                    {
                        id: '5',
                        innerCode: '5',
                        tagName: '已购产品'
                    }
                ],
                tagIndex: '0',
                active: 4,
                proposalList: [],
                totalCount: 0,
                isLoad: true,
                allLoaded: false,
                queryLoading: true,
                offset: 1,
                limit: 10,
                isDel: false,
                isTrue: false,//确定删除
            }
        },
        computed: {
            ...mapGetters(['user']),
        },
        components: {

        },
        mounted () {
            window.addEventListener('scroll', this.handleScroll)
        },
        created () {
            // let r="20201013".replace(/^(\d{4})(\d{2})(\d{2})$/, "$1-$2-$3")
            // console.log('r',r)
            this.queryBasicIntroduction();//基本介绍
            this.queryProposalList();//历史方案列表
        },
        methods: {
            handleScroll() {
                if (scroll.getScrollTop() + scroll.getClientHeight() > (scroll.getScrollHeight() - 5)) {
                    this.loadMore();
                }
            },

            loadMore() {
                if (this.queryLoading) {
                    return
                }
                if (!this.isLoad) {
                    this.isLoad = true;
                    if (this.offset %2 == 0) {
                        this.offset += 10;
                    } else {
                        this.offset += 9;
                    }
                    // this.offset += 10;
                    this.queryProposalList();
                }
            },

            handleClickTag (index, title) {
                this.tagIndex = this.tabList[index].innerCode;
                this.offset = 1;
                if (this.tagIndex == '0') {
                    this.$router.push({ path: '/customerDetail/' + this.clientId + '/' + this.clientNewId});
                } else if (this.tagIndex == '1') {
                    this.$router.push({ path: '/orderList/' + this.clientId + '/' + this.clientNewId});
                } else if (this.tagIndex == '2') {
                    this.$router.push({ path: '/trailList/' + this.clientId + '/' + this.clientNewId});
                } else if (this.tagIndex == '3') {
                    this.$router.push({ path: '/followList/' + this.clientId + '/' + this.clientNewId});
                } else if (this.tagIndex == '5') {
                    this.$router.push({ path: '/payProductList/' + this.clientId + '/' + this.clientNewId});
                }
            },

            queryBasicIntroduction () {
                const _data = {
                    saasId: tool.app.saasId,
                    clientNewidId: this.clientNewId
                }
                api_sell.queryBasicIntroduction(_data).then(data => {
                    if (data.status == tool.rtCode.status) {
                        this.nikeName = data.nikeName;
                        this.sex = data.sex;
                        this.getSource = data.getSource;
                        this.customerStar = data.customerStar;
                        this.cerCode = data.cerCode;
                    } else {
                        tool.toastMessage(data.message, 'error');
                    }
                })
            },

            queryProposalList () {
                const _data = {
                    agentCode: this.user.userInfo.agentcode,
                    saasId: tool.app.saasId,
                    amountFlag: "",//表示建议书是多产品还是单产品 1-单 2-多  空-全部
                    operation: "1",
                    branchComCode: "",
                    pagesize: this.limit,
                    pageoffset: this.offset,
                    customerId: this.clientId,
                    platformId: tool.app.platformId
                }
                api_sell.queryProposalList(_data).then(data => {
                    if (data.status == tool.rtCode.status) {
                        this.isLoad = false;
                        this.totalCount = data.totalCount;
                        this.proposalList = data.dataM.proposalList;
                        if (this.offset === 1 || this.proposalList.length === 0) {
                            this.proposalList = data.dataM.proposalList ? data.dataM.proposalList : []
                            if (this.proposalList.length < this.totalCount) {
                                this.queryLoading = false;
                            }
                        } else {
                            this.proposalList = this.proposalList.concat(data.dataM.proposalList);
                        }
                        this.allLoaded = this.proposalList.length >= this.totalCount;
                        if (this.allLoaded) {
                            this.queryLoading = true;
                        }
                    } else {
                        tool.toastMessage(data.message, 'error');
                    }
                })
            },

            goProposalEdit (proposalId) {//复制方案到lzg
                const channelUserId = this.user.userInfo.mobile || this.user.userInfo.agentcode,
                    identificationStatus = this.user.userInfo.status || '';
                window.location.href = tool.app.lzgUrl + '#/source/channelUserId=' + channelUserId + '&opType=4&status=' + identificationStatus + '&proposalId=' + "proposalId";
            },

            delProposal (id) {
                // this.isDel = true;
                // if (this.isTrue) {
                    const _data = {
                        saasId: tool.app.saasId,
                        proposalNoList: [id],
                        agentCode: this.user.userInfo.agentcode,
                        platformId: tool.app.platformId
                        // platformId: "2724341dfdc5463cbf167f1195da6e3e"
                    }
                    api_sell.delProposalList(_data).then(data => {
                        if (data.status == tool.rtCode.status) {
                            this.queryProposalList();
                            tool.toastMessage(data.message);
                        } else {
                            tool.toastMessage(data.message, 'error');
                        }
                    })
                // }
            },

            confirmDel () {
                this.isDel = false;
                this.isTrue = true;
            },

            cancelDel () {
                this.isDel = false;
                this.isTrue = false;
            },

            addRecord () {
                this.$router.push({ path: '/followRecord/' + this.clientId + '/' + this.clientNewId + '/add'});
            },

            goBack () {
                this.$router.push({ path: '/sellList/' + "1"});
            },


        },
        destroyed() {
            window.removeEventListener('scroll', this.handleScroll)
        },
    }
</script>
<style scoped>

</style>
