<template>
  <div class="bg7">
    <div class="fun-top-panel bg-my  ">
      <span
        class="mess-back "
        @click="goBack()"
      >
        <div class="cont-wh"></div>
      </span>
      <span class="title c7 f3 dblock2 t-center ">全部客户</span>
      <span class="right"><b
          class="fun-icon icon-search"
          @click="$router.push({name:'searchclient'})"
        ></b></span>
    </div>
    <div class="main-container mar3-7 clearfix">
      <div class="my-n-txtbox pd1">
        <section class="my2020-nav-top  mnt1 bg7 ">
          <ul class=" f2 row mar0">
            <li class="col-4 pad1-1 none t-center bor-b">
              <b class="f3 c5">{{allNum}}<span class="f1 c4">人</span></b>
              <div class="t-center f2 c4">全部客户</div>
            </li>
            <li class="col-4 pad1-1 none t-center bor-b">
              <b class="f3 c5">{{orderNum}}<span class="f1 c4">人</span></b>
              <div class="t-center f2 c4">订单客户</div>
            </li>
            <li class="col-4 pad1-1 t-center none bor-b">
              <b class="f3 c5">{{dealNum}}<span class="f1 c4">人</span></b>
              <div class="t-center f2 c4">成交客户</div>
            </li>
            <li class="col-4 pad1-1 t-center none">
              <b class="f3 c5">{{officialNum}}<span class="f1 c4">人</span></b>
              <div class="t-center f2 c4">加公众号</div>
            </li>
            <li class="col-4 pad1-1 none t-center ">
              <b class="f3 c5">{{wechatNum}}人</b>
              <div class="t-center f2 c4">加微信</div>
            </li>
            <li class="col-4 pad1-1 none t-center none">
              <b class="f3 c5">{{adviserNum}}<span class="f1 c4">人</span></b>
              <div class="t-center f2 c4">已绑定顾问</div>
            </li>
          </ul>
        </section>

        <div class="main-top mar3-9 bg7 ">
          <div class="sale-nav row mar6-6 pad6">
            <div
              class="col-6 pad8"
              @click="$router.push({name:'achieveclient'})"
            >
              <div class="sale-btn-l2 t-left">
                <div class="pad5-3">
                  <h3 class="f4 c7">成交客户</h3>
                  <p class="c7 f1">本月有{{renewNum}}位待续费客户</p>
                </div>
              </div>
            </div>
            <div class="col-6 pad8">
              <div class="sale-btn-r2 t-left">
                <div class="pad5-3">
                  <h3 class="f4 c7">客户关怀</h3>
                  <p class="c7 f1">近7天生日客户 {{careNum}}位</p>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <section
        class="bg7 b-radius1 mar3-2"
        style="position:relative;"
      >
        <div
          class="box"
          style="width:90%;"
        >
          <van-dropdown-menu>
            <van-dropdown-item
              @change="changeMenu"
              @open="menutype=1"
              v-model="customerStatus"
              :options="option1"
            />
            <van-dropdown-item
              @change="changeMenu"
              @open="menutype=2"
              v-model="customerType"
              :options="option2"
            />
            <van-dropdown-item
              @change="changeMenu"
              @open="menutype=3"
              v-model="customerRelation"
              :options="option3"
            />
            <van-dropdown-item
              @change="changeMenu"
              @open="menutype=4"
              v-model="sort"
              :options="option4"
            />
          </van-dropdown-menu>
        </div>
        <div
          class=" fresh   "
          style="position:absolute;right:8px;top:5px;"
        >
          <div>
            <b
              class="fun-icon icon-select mar3-2"
              title="筛选"
              @click="show = true"
            ></b>
          </div>
        </div>
        <van-popup
          v-model="show"
          round
          position="bottom"
          :style="{ height: '70%'}"
        >
          <!-- <div class="mask-layer"></div> -->
          <div
            class="pb1 pad5"
            v-if="tagList.length>0"
          >
            <div class="c5 f2-1">客户需求</div>
            <div class="sel-b3">
              <label
                v-for="child1 in tagList[1].demand1"
                :key="child1.tagCode"
              >
                <input
                  type="radio"
                  name="radio1"
                  :value="child1.tagCode"
                  v-model="demand1"
                ><b>{{child1.tagName}}</b>
              </label>
              <label
                v-for="child2 in tagList[1].demand2"
                :key="child2.tagCode"
              >
                <input
                  type="checkbox"
                  :value="child2.tagCode"
                  v-model="demand2"
                ><b>{{child2.tagName}}</b>
              </label>

            </div>
            <div class="c5 f2-1">客户能力</div>
            <div class="sel-b3">
              <label
                v-for="child3 in tagList[2].ability1"
                :key="child3.tagCode"
              >
                <input
                  type="radio"
                  name="radio2"
                  :value="child3.tagCode"
                  v-model="ability1"
                ><b>{{child3.tagName}}</b>
              </label>
              <label
                v-for="child4 in tagList[2].ability2"
                :key="child4.tagCode"
              >
                <input
                  type="checkbox"
                  :value="child4.tagCode"
                  v-model="ability2"
                ><b>{{child4.tagName}}</b>
              </label>
            </div>
            <div class="c5 f2-1">客户意愿</div>
            <div class="sel-b3">
              <!-- intention1 -->
              <label
                v-for="child5 in tagList[0].intention1"
                :key="child5.tagCode"
              >
                <input
                  type="radio"
                  name="radio3"
                  :value="child5.tagCode"
                  v-model="intention1"
                ><b>{{child5.tagName}}</b>
              </label>
              <label
                v-for="child6 in tagList[0].intention2"
                :key="child6.tagCode"
              >
                <input
                  type="checkbox"
                  :value="child6.tagCode"
                  v-model="intention2"
                ><b>{{child6.tagName}}</b>
              </label>
            </div>
            <div class="c5 f2-1">创建时间</div>
            <div class="sel-b3">
              <label>
                <input
                  type="radio"
                  value="1"
                  name="date"
                  v-model="date"
                ><b>今日</b>
              </label>
              <label>
                <input
                  type="radio"
                  value="2"
                  name="date"
                  v-model="date"
                ><b>7天</b>
              </label>
              <label>
                <input
                  type="radio"
                  value="3"
                  name="date"
                  v-model="date"
                ><b>30天</b>
              </label>
            </div>
            <section class="pad5-4">
              <div class="timer-box no-t f2-1">
                <span
                  class="f1 c5 date t-center c-p"
                  @click="timertype=1,timer=true,date=''"
                >{{startdate?startdate:'开始日期'}}</span>
                <span class=" c5 sp1 t-center"><b></b></span>
                <span
                  class="f1 c5 date t-center c-p"
                  @click="timertype=2,timer=true,date=''"
                >{{enddate?enddate:'结束日期'}}</span>
              </div>
            </section>
            <div class="pad5-9  b1  border-t">
              <div class="reg-bt t-center">
                <button
                  type="button"
                  class="b-left"
                  @click="
                    intention1='',//意愿
                    intention2=[],
                    demand1='',//需求
                    demand2=[],
                    ability1='',//能力
                    ability2=[],
                    date='',
                    startdate='',
                    enddate=''
                  "
                >重置</button>
                <button
                  type="button"
                  class="b-right"
                  @click="downClick"
                >完成</button>
              </div>
            </div>
          </div>
        </van-popup>
        <van-popup
          v-model="timer"
          round
          position="bottom"
          :style="{height:'50%'}"
        >
          <van-datetime-picker
            @confirm="confirm"
            @cancel="timer = false,startdate='',enddate=''"
            v-model="currentDate"
            type="date"
            title="选择年月日"
            :formatter="formatter"
          />
        </van-popup>
      </section>
      <section class="bg7 border-t">
        <van-list
          v-model="loading"
          :finished="finished"
          :immediate-check="false"
          finished-text="没有更多了"
          @load="onLoad"
        >
          <div
            class="blk-cont-box posi2 border-b1 mar6-2"
            v-for="(item,index) in  list"
            :key="index"
            @click="goDetail(item.clientId,item.resultId)"
          >
            <div class="img-box posi2">
              <img src="../../assets/img/index/bar_bg.png" />
              <b
                class="state c-p"
                v-show="item.getSource == 1"
              >分配客戶</b>
              <b
                class="state c-p"
                v-show="item.getSource == 2"
              >取数客戶</b>
              <b
                class="state c-p"
                v-show="item.getSource == 3"
              >自建客户</b>
              <!-- <b
                class="state c-p"
                v-show="item.getSource == 4"
              >成交客户</b> -->
            </div>
            <div class="right-box posi2  c-p">
              <h3 class="f2 c6 mar7-2">{{item.name}}
              </h3>
              <div class="f2 c4">
                <span>年龄：</span><span >{{item.age?item.age+'岁':'未知'}}</span>
              </div>
              <div class=" f2 c4">
                <span>客户星级：</span><span class="stars-box"><i
                    v-for="(item,index) in item.customerStar"
                    :key="index"
                  ></i>
                  <i
                    class="grey"
                    v-for="(gray,i) in grayStar" :key="i+1"
                  ></i></span>

              </div>
              <div class=" f2 c4">
                <span>创建时间：</span><span v-if="item.date">{{item.date  | dataFormat('yyyy-MM-dd hh:mm:ss')}}</span>
              </div>
              <div
                class="f1"
                v-if="item.activitySource"
              ><b class="ek-btn-5">{{item.activitySource?item.activitySource:''}}</b></div>
            </div>
            <b class="flag">客户行销</b>
          </div>
        </van-list>

      </section>
      <!-- <div
        class="f2 pad888"
        v-if="list.length ==0"
      >
        <div class="lzg-h-more posi2 t-center">
          <span class="c5 bg7 posi2 c222">没有更多啦</span>
        </div>
      </div> -->
    </div>
  </div>
</template>

<script>
import { api_my, api_sell } from '@/api/index'
import { mapGetters } from 'vuex'
import * as tool from '@/common/Tool'
import Vue from 'vue'
import '@vant/touch-emulator'
import {
  Popup, DropdownMenu, DropdownItem,
  Field, Picker, Overlay, DatetimePicker, List
} from 'vant';
Vue.use(Picker)
Vue.use(Overlay)
Vue.use(Popup)
Vue.use(List)
Vue.use(Field)
Vue.use(DatetimePicker)
Vue.use(DropdownMenu);
Vue.use(DropdownItem);
export default {
  data() {
    return {
      offset: 0,
      limit: 10,
      total: 0,
      loading: false,
      finished: false,
      show: false,
      menutype: '',
      grayStar:0,
      // 1:待跟进；2：跟进中；3：计划跟进；4：待成交 5：被拉黑 ；6：已成交 ；7：已放弃
      option1: [
        { text: '行销状态', value: '' },
        { text: '待跟进', value: 1 },
        { text: '跟进中', value: 2 },
        { text: '计划跟进', value: 3 },
        { text: '待成交', value: 4 },
        { text: '已放弃', value: 5 },
        { text: '已成交', value: 6 },
      ],
      // 1-系统分配;2-主动取数;3-自建客户
      option2: [
        { text: '客户类型', value: '' },
      ],
      // 1-添加微信;2-关注公众号;3-绑定顾问
      option3: [
        { text: '客户关系', value: '' },
        { text: '添加微信', value: 1 },
        { text: '关注公众号', value: 2 },
        // { text: '绑定顾问', value: 3 },
      ],
      // 1-时间顺序 2-质量顺序
      option4: [
        { text: '排序', value: '' },
        { text: '时间顺序', value: 1 },
        { text: '质量顺序', value: 2 },
      ],
      list: [],
      adviserNum: '',
      allNum: '',
      careNum: '',
      dealNum: '',
      officialNum: '',
      orderNum: '',
      renewNum: '',
      wechatNum: '',
      customerStatus: '',
      customerType: '',
      customerRelation: '',
      sort: 1,
      tagList: [],
      intention1: '',//意愿
      intention2: [],
      demand1: '',//需求
      demand2: [],
      ability1: '',//能力
      ability2: [],
      date: '',
      timer: false,
      currentDate: new Date(),
      timertype: '',
      startdate: '',
      enddate: ''
    }
  },
  computed: {
    ...mapGetters(['user'])
  },
  created() {
    this.gettags();
    this.getCustomerSearchList();
    this.getCustomerCount();
  },
  mounted() {
    this.labelType();
  },
  methods: {
    goBack() {
      this.$router.go(-1);
    },
    goDetail(clientId, resultId) {
      this.$router.push({ name: 'customerDetail', params: { q: clientId, r: resultId } });
    },
    labelType() {
      const _data = { type: 'funzg_batch_apply_mode/' + tool.app.platformCode + '/' + tool.app.saasId }
      api_sell.sysDict(_data).then(data => {
        if (data.status == tool.rtCode.status) {
          console.log(data.params.dicts);
          data.params.dicts.forEach(item => {
            let obj = {
              text: item.name,
              value: item.value
            }
            this.option2.push(obj)
          })
        } else {
          tool.toastMessage(data.message, 'error')
        }
      })
    },
    getCustomerCount() {
      let _data = {
        "saasId": this.user.saasId,
        "offset": this.offset,
        "limit": this.limit,
        "agentUserId": this.user.userid,
      }
      api_my.getCustomerCount(_data).then(res => {
        if (res.status == tool.rtCode.status) {
          this.adviserNum = res.adviserNum
          this.allNum = res.allNum
          this.careNum = res.careNum
          this.dealNum = res.dealNum
          this.officialNum = res.officialNum
          this.orderNum = res.orderNum
          this.renewNum = res.renewNum
          this.wechatNum = res.wechatNum
        } else {
          tool.toastMessage(res.message, 'error')
        }
      })
    },
    getCustomerSearchList() {
      // let _data ={
      //   saasId:this.user.userInfo.saasId,
      //   offset:0,
      //   limit:10,
      //   agentUserId:this.user.userInfo.userId
      // }
      let _data = {
        "saasId": this.user.saasId,
        "offset": this.offset,
        "limit": this.limit,
        "customerStatus": this.customerStatus,
        "customerType": this.customerType,
        "agentUserId": this.user.userid,
        "customerRelation": this.customerRelation,
        "sort": this.sort
      }
      api_my.getCustomerSearchList(_data).then(res => {
        if (res.status == tool.rtCode.status) {
          this.loading = false;
          if (res.result == null || res.result.length == 0) {
            this.finished = true;
            return;
          }
          this.total = res.total;
          this.list = this.list.concat(res.result);
          res.result.forEach(item=>{
             this.grayStar = 5-item.customerStar
          })
          if (this.list.length >= this.total) {
            this.finished = true;
          }
        } else {
          tool.toastMessage(res.message, 'error')
        }
      })
    },
    onLoad() {
      this.offset++;
      this.getCustomerSearchList();
    },
    changeMenu(i) {
      switch (this.menutype) {
        case 1:
          this.customerStatus = i;
          break;
        case 2:
          this.customerType = i;
          break;
        case 3:
          this.customerRelation = i;
          break;
        case 4:
          this.sort = i;
          break;
      }
      this.getCustomerSearchList();
    },
    gettags() {
      let _data = {
        saasId: this.user.userInfo.saasId
      }
      api_my.getTags(_data).then(res => {
        if (res.status == tool.rtCode.status) {
          this.tagList = res.resultTags;
        }
      })
    },
    downClick() {
      let tagjson = [
        // date:''
        { intention1: this.intention1, intention2: this.intention2 },
        { demand1: this.demand1, demand2: this.demand2 },
        { ability1: this.ability1, ability2: this.ability2 },
      ]
      let dates = {
        date: ''
      };
      if (this.startdate != '' && this.enddate != '') {
        dates.date = {
          startDate: this.startdate,
          endDate: this.enddate
        }
      } else {
        dates.date = this.date

      }
      tagjson.push(dates)
      console.log(tagjson);
    },
    formatter(type, value) {
      if (type === 'year') {
        return `${value}年`
      } else if (type === 'month') {
        return `${value}月`
      } else if (type === 'day') {
        return `${value}日`
      }
      return value
    },
    confirm(val) {
      let year = val.getFullYear()
      let month = val.getMonth() + 1
      let day = val.getDate()
      if (month >= 1 && month <= 9) { month = `0${month}` }
      if (day >= 1 && day <= 9) { day = `0${day}` }
      let value = `${year}-${month}-${day}`
      if (this.timertype == 1) {
        this.startdate = value;
      } else {
        this.enddate = value;
      }
      this.timer = false;
    },
  },

}
</script>


<style>
.van-dropdown-menu__bar {
  box-shadow: none;
}
</style>
