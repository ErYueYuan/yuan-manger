<template>
  <div>
    <top-panel :topPanel="topPanel"></top-panel>
    <div class="main-top p-fix bg3 pad6 b-radius2"></div>
    <div class="main-top p-fix3 bg7 b-radius2">
      <div class="sale-nav row mar6-5 pad6">
        <div class="col-6 pad8"> <div class="sale-btn-l t-center c-p"><b class="s-icon b5"></b>新建计划书</div></div>
        <div class="col-6 pad8"> <div class="sale-btn-r t-center c-p"><b class="s-icon b6"></b>对比计划书</div></div>
      </div>
    </div>
    <div class="main-container mar4-2 clearfix">
      <section class=" b-radius2 ">
        <!--
        <div class="clearfix bg7 t-center">
          <div class="sel-p5 pro active">
            <label class="f3-1"><b>计划书</b></label>
          </div>
          <div class="sel-p5 pro">
            <label class="f3-1"><b>家庭计划书</b></label>
          </div>
          <div class="sel-p5 pro">
            <label class="f3-1"><b>对比方案</b></label>
          </div>
        </div>
        -->
        <div class="   border-t2 clearfix ">
          <section class="blk-cont2020  " v-for="(item, index) in proposalList" :key="index">
            <div class="ek-com-tit3 bg7 f3 c4 pad1-3 border-b1"><b><img class="lazy-p" src="https://www.baoxian.com/product_file/ERiskPic/100901007.jpg" alt="pic"></b>{{item.appentName}}<span class="f-right f2" :class="item.statustrail==='2'?'c8':'c6'">{{item.statustrail==='0'?'尚未分享':(item.statustrail==='1'?'客户未查看':(item.statustrail==='2'?'客户已查看':''))}}</span></div>
            <ul class="cont-blk  icon-wrap ">
              <li class="li-p7 bg7 posi2 clearfix">
                <div class="product2020 f-left posi2">
                  <img class="lazy-p" :src="item.ERiskPicRelaPath" alt="pic">
                </div>
                <div class="info-blk  ">
                  <h3 class=" mess f3 c44 ">{{item.riskName}}
                    <span class="f-right"><b class="fun-icon icon-edit2 "></b><b class="fun-icon icon-del "></b></span>
                  </h3>
                  <p class="f1 c4  mar3-9 mess">个人保障方案</p>
                  <div class="t-left f1 c4 mar3-9">编码: {{item.proposalNo}}</div>
                  <div class="t-left c4 f1 mar3-9">
                    首期保费:<span class="c9">{{item.totalamount + '元'}}</span>
                  </div>
                </div>
                <div class="sel-b4">
                  <label>
                    <input name="a" type="radio" :value="item.proposalId" v-model="proposalId" @change="doProposal"><b></b>
                  </label>
                </div>
              </li>
            </ul>
          </section>
        </div>
      </section>
    </div>
    <div class="posi5 pad5-8 bg7 b-shadow ">
      <button type="button" class="hx-bt3 t-center" @click="goMessBack">选好了</button>
    </div>
  </div>
</template>

<script>
  import { mapGetters } from 'vuex'
  import { TopPanel } from '@/components/index'
  import * as tool from '@/common/Tool'
  import { api_user } from '@/api/index'
  import DataSource from '@/common/DataSource'
  import Vd from '@/common/Validator'

  export default {
    name: "ProposalList",
    data () {
      return {
        sourceChannel: tool.globalData,
        proposalPath: this.$route.params.path,
        topPanel: {
          back: true,
          titles: "计划书",
        },
        proposalList: [],
        total: 0,
        isLoad: true,
        allLoaded: false,
        queryLoading: true,
        offset: 1,
        limit: 10,
        proposalId: '',
        promoteLinks: ''
      }
    },
    components: {
      'top-panel': TopPanel,
    },
    computed: {
      ...mapGetters(['user']),
    },
    beforeCreate: function() {
      document.getElementsByTagName("body")[0].className = "bg3";
    },
    created () {
      this.getProposalList()
    },
    mounted () {
      window.addEventListener('scroll', this.handleScroll)
    },
    methods: {
      getProposalList () {
        const _data = {
          saasId: tool.app.saasId,
          agentCode: this.user.userInfo.agentcode,
          operation: '1', // 0-计划书模板  1我的计划书  2对比方案   3- 收藏的对比方案计划书  5-对比+计划书
          pageoffset: this.offset,
          pagesize: this.limit,
          amountFlag: ''
        }
        api_user.proposalList(_data).then(data => {
          if (data.status === tool.rtCode.status) {
            this.isLoad = false
            this.total = data.total
            if (this.offset === 0 || this.proposalList.length === 0) {
              this.proposalList = data.dataM && data.dataM.proposalList ? data.dataM.proposalList : []
              if (this.proposalList.length < this.total) {
                this.queryLoading = false
              }
            } else {
              this.proposalList = data.dataM && data.dataM.proposalList ? this.proposalList.concat(data.dataM.proposalList) : this.proposalList
            }
            this.allLoaded = this.proposalList.length >= this.total
            if (this.allLoaded) {
              this.queryLoading = true
            }
          } else {
            tool.toastMessage(data.message, 'error')
          }
        })
      },
      doProposal () {
        const channelUserId = this.user.userInfo.mobile || this.user.userInfo.agentcode,
          identificationStatus = this.user.userInfo.status || ''
        this.promoteLinks = tool.app.lzgUrl + '#/source/channelUserId=' + channelUserId + '&opType=6&status=' + identificationStatus + '&proposalId=' + this.proposalId + '&platformId=2724341dfdc5463cbf167f1195da6e3e&platformCode=12'
        if (this.proposalPath !== '2') {
          window.location.href = this.promoteLinks
        }
      },
      goMessBack () {
        if (Vd.required(this.proposalId, '请选择计划书')) {
          DataSource.set('sendProposalMess', this.promoteLinks, 2)
          this.$router.go(-1)
        }
      },
    },
    beforeDestroy: function() {
      document.body.removeAttribute("class", "bg3")
    },
    destroyed() {
      window.removeEventListener('scroll', this.handleScroll)
    }
  }
</script>

<style scoped>

</style>
