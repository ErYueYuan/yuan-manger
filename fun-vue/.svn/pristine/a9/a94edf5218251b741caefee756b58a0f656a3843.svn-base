<template>
  <div>
    <div class="fun-top-panel bg7  ">
      <span class="mess-back " @click="goBack"><div class="cont"></div></span>
      <span class="title c3 f3 dblock2 t-center ">选择发言人</span>
    </div>
    <div class="main-top p-fix bg7 b-radius2">
      <section class="f-flex pad7-1 border-b1">
        <div class="sear-bb ">
          <section class="">
            <form action="/">
              <van-search
                shape="round"
                v-model="searchText"
                placeholder="请输入搜索关键词"
                @search="handleSearch"
                @clear="handleClear"
              />
            </form>
          </section>
        </div>
        <!--<div class="all-box t-center f2 c8 l-h2">-->
          <!--<div class="sel-pp5 all pro">&lt;!&ndash;active为选中状态&ndash;&gt;-->
            <!--<span>筛选</span><span class="triangle-b5 "></span>-->
          <!--</div>-->
        <!--</div>-->
      </section>
    </div>
    <div class="main-container mar4-9 clearfix">
      <section class="cus-list" v-for="(item, index) in initialsPyList.segs" :key="index">
        <div class="tit f3 t-left c4">{{item.initial}}</div>
        <div class="list bg7 border-b1 posi2" v-for="(it, ind) in item.data" :key="ind">
          <div class="img-box ">
            <img v-lazy="it.portraitUrl">
          </div>
          <h3 class="right-box f3 c6 ">{{it.nickname}}</h3>
          <div class="sel-b4 sb1">
            <label>
              <input type="checkbox" name="check" :value="it.wechatId" :checked="checkVal.indexOf(it.wechatId) !== -1" @click="changeCheckVal(it)"><b></b>
            </label>
          </div>
        </div>
      </section>
    </div>
    <div class="pad1">
      <span class="hx-bt3" @click="sendMessNext">下一步</span>
    </div>
  </div>
</template>

<script>
  import Vue from 'vue'
  import { mapGetters } from 'vuex'
  import { api_mess } from '@/api/index'
  import { Search, Empty, Lazyload } from 'vant'
  import * as tool from '@/common/Tool'
  import DataSource from "@/common/DataSource";

  Vue.use(Search).use(Empty).use(Lazyload, { lazyComponent: true })

  export default {
    name: "GroupChat",
    data () {
      return {
        checkVal: [],
        checkList: [],
        addressBookInitial: [],
        initialsPyListCopy: {},
      }
    },
    props: {
      initialsPyList: {
        type: Object, //要求父组件数据传输类型
        required: true  //必传
      },
      QYWeChatId: {
        type: String,
        required: true
      }
    },
    computed: {
      ...mapGetters(['user']),
    },
    beforeCreate: function() {
      document.getElementsByTagName("body")[0].className = "bg3";
    },
    mounted () {
      this.initialsPyListCopy = this.initialsPyList
      console.log(this.initialsPyList)
    },
    methods: {
      changeCheckVal (it) {
        let ind = this.checkVal.indexOf(it.wechatId)
        if (ind === -1) {
          this.checkVal.push(it.wechatId)
          this.checkList.push({
            weChatId: it.wechatId,
            nickName: it.nickname
          })
        } else {
          this.checkVal.splice(ind, 1)
          this.checkList.splice(ind, 1)
        }
      },
      sendMessNext () {
        if (this.checkList.length > 0) {
          DataSource.set('groupChat', this.checkList, 2)
          let parameter = 'messType=qyWx&wid=' + this.QYWeChatId + '&GCid=1' // GCid 群发
          this.$router.push({name: 'messWindow', params: {p: parameter}})
        } else {
          tool.toastMessage('请选择需要发送的好友', 'warn')
        }
      },
      addressBookIntegrate(customerAddressBook) {
        if (customerAddressBook.length == 0) return;
        if (!String.prototype.localeCompare) return null;
        let letters = "*ABCDEFGHJKLMNOPQRSTWXYZ".split(""),
          zh = "阿八嚓哒妸发旮哈讥咔垃痳拏噢妑七呥扨它穵夕丫帀".split(""),
          segs = [], // 存放数据
          res = {},
          curr,
          re = /[^\u4e00-\u9fa5]/,//中文正则
          pattern = new RegExp("[`\\-~!@#$^&*()=|{}':;',\\[\\].<>《》/?~！@#￥……&*（）——|{}【】‘；：”“'。，、？12345678990]"); //特殊符号
        letters.filter((items, i) => {
          curr = {
            initial: '', //字母
            data: [],  //数据
          };
          customerAddressBook.map((v, index) => {
            // 特殊字符
            if (pattern.test(v.nickname[0])) {
              if ((!zh[i - 1] || zh[i - 1].localeCompare(v.nickname) <= 0) && v.nickname.localeCompare(zh[i]) == -1) {
                curr.data.push(v);
              }
            }
            // 判断首个字是否是中文
            if (re.test(v.nickname[0])) {
              // 英文
              if (v.nickname[0].toUpperCase() == items) {
                curr.data.push(v);
              }
            } else {
              // 中文
              if ((!zh[i - 1] || zh[i - 1].localeCompare(v.nickname) <= 0) && v.nickname.localeCompare(zh[i]) == -1) {
                curr.data.push(v);
              }
            }
          })
          if (curr.data.length) {
            curr.initial = letters[i]
            this.addressBookInitial.push(letters[i])
            segs.push(curr);
            curr.data.sort((a, b) => {
              return a.nickname.localeCompare(b.nickname);
            });
          }
        })
        res.segs = Array.from(new Set(segs)) //去重
        this.initialsPyList = res
      },
      handleSearch () {
        const _data = {
          operatorId: this.user.operatorManageInfo.id,
          searchName: this.searchText
        }
        api_mess.getOperatorManageInfo(_data).then(res => {
          if (res.code == '200') {
            this.addressBookInitial = []
            let customerAddressBook = res.data[0].operations.friendList
            this.addressBookIntegrate(customerAddressBook)
          } else {
            tool.toastMessage(res.msg, 'error')
          }
        })
      },
      handleClear () {
        this.addressBookInitial = []
        this.initialsPyList = this.initialsPyListCopy
      },
      goBack () {
        this.$emit('chooseFriendGroup')
      }
    },
    beforeDestroy: function() {
      document.body.removeAttribute("class", "bg3")
    },
  }
</script>

<style scoped>

</style>
