<template>
  <div>
    <div v-show="!replyPopStatus">
      <div class="fun-top-panel bg7  ">
        <div class="f2 c8 right">客户主页</div>
        <span class="mess-back " @click="goBack"><div class="cont"></div></span>
        <span class="title c3 f3 dblock2 t-center ">{{messUser}}</span>
      </div>
      <div class="chat-tag-box" :class="tagStatus ? 'more' : ''">
        <b v-for="(tags, index) in tagsListDown" :key="'tags-' + index" v-show="!tagStatus">{{tags}}</b><b v-show="tagsList.length>3&&!tagStatus">...</b>
        <b v-for="(tags, index) in tagsList" :key="'tags' + index" v-show="tagStatus">{{tags}}</b>
        <div class="t-center c-p" @click="handleTagMore" v-if="tagsList.length>3"><span :class="tagStatus ? 'up' : 'down'"></span></div>
      </div>

      <div class="chatting-wrapper" id="roll_top" :class="fileStatus?'open':''">
        <div class="message-box" :class="item.senderFlag === '1' ? 'customer' : (item.senderFlag === '0' ? 'agent' : '')" v-for="(item, index) in messList" :key="index">
          <div class="time f2">{{item.modifydate | dataFormat('yyyy-MM-dd')}}<span> {{item.modifydate | dataFormat('hh:mm')}}</span></div>
          <div class="cont">
            <div class="img-box"><img :src="item.head" /></div>
            <div class="right-box">
              <h3 class="f1 c5">{{item.name}}</h3>
              <div class="f1 c6 wrap">{{item.content}}</div>
            </div>
          </div>
        </div>
      </div>
      <div class="chatting-footer b-shadow">
        <div class="floor1 d-flex">
          <div class="voice"><b title="语音"></b></div>
          <div class="chat"><textarea placeholder="输入发送内容" v-model="sendMess"></textarea></div>
          <div class="other"><b class="b1" title="表情图标"></b><b class="b2" title="附件" @click="otherFile"></b></div>
        </div>
        <div class="floor2 posi2">
          <label>短信<input type="checkbox"/><b></b></label>
          <label>邮箱<input type="checkbox"/><b></b></label>
          <label>公众号<input type="checkbox"/><b></b></label>
          <label>企业微信<input type="checkbox"/><b></b></label>
          <div class="submit-b">
            <button class="submit" @click="messSubmit">发送</button>
          </div>
        </div>
        <div class="floor3" :class="!fileStatus?'hide':''"><!--选择分享链接默认收起-->
          <div class="f1 c5 pad1-3">选择分享链接：</div>
          <div id="chatShare" class="swiper-container ">
            <div class="swiper-wrapper">
              <div class="swiper-slide ">
                <div class="new-nav-box tools">
                  <ul class="u1 clearfix">
                    <li class="l2  f2 pad1 c-p" @click="handleSendReply">
                      <span class="c1"></span>快捷回复
                    </li>
                    <li class="l2 f2 pad1 c-p">
                      <span class="three"></span>知识库
                    </li>
                    <li class="l2 f2 pad1 c-p">
                      <label for="upLoadPhoto">
                        <span class="c2"></span>图片
                        <upload-file
                          ref="upLoadPhoto"
                          :upload-id="upLoadPhoto"
                          style="display:none;"
                          @iptFile="iptFileFun"
                        />
                      </label>
                    </li>
                    <li class="l2 f2 pad1 c-p" @click="sendSharePath('productList')">
                      <span class="four"></span>产品
                    </li>
                    <li class="l2 f2 pad1 c-p" @click="sendSharePath('proposalList')">
                      <span class="five"></span>计划书
                    </li>
                    <li class="l2 f2 pad1 c-p" >
                      <span class="seven"></span>海报
                    </li>
                    <li class="l2  f2 pad1 c-p" @click="sendSharePath('articleList')">
                      <span class="one"></span>文章
                    </li>
                    <li class="l2 f2 pad1 c-p">
                      <span class="six"></span>名片
                    </li>
                  </ul>
                </div>
              </div>
              <div class="swiper-slide ">
                <div class="new-nav-box tools">
                  <ul class="u1 clearfix">
                    <li class="l2 f2 pad1 c-p">
                      <span class="two"></span>风险测评
                    </li>
                    <li class="l2 f2 pad1 c-p">
                      <span class="three"></span>资产配置
                    </li>
                    <li class="l2 f2 pad1 c-p" >
                      <span class="eight"></span>微店
                    </li>
                  </ul>
                </div>
              </div>
            </div>
            <div class="swiper-pagination"></div>
          </div>
        </div>
      </div>
    </div>
    <fast-reply v-if="replyPopStatus" @sendFastReply="sendFastReplyFun"></fast-reply>
  </div>
</template>

<script>
  import { mapGetters } from 'vuex'
  import * as tool from '@/common/Tool'
  import { api_mess, api_sell } from '@/api/index'
  import { UploadFile } from '@/components/index'
  import Swiper from 'swiper'
  import 'swiper/css/swiper.min.css'
  import 'swiper/js/swiper.min.js'
  import DataSource from '@/common/DataSource'
  import FastReply from './FastReply'

  export default {
    name: "MessWindow",
    data () {
      return {
        uid: this.$route.params.uid,
        oid: this.$route.params.oid,
        aid: this.$route.params.aid,
        messUser: DataSource.get('messUser', 2) || '',
        messList: [],
        sendMess: '',
        sendPhoto: '',
        fileStatus: false,
        upLoadPhoto: 'upLoadPhoto',
        sendProductMess: DataSource.get('sendProductMess', 2) || '',
        sendProposalMess: DataSource.get('sendProposalMess', 2) || '',
        sendArticleMess: DataSource.get('sendArticleMess', 2) || '',
        sendReplyMess: '',
        tagStatus: false,
        tagsListDown: [],
        tagsList: [], // 标签列表
        replyPopStatus: false
      }
    },
    computed: {
      ...mapGetters(['user']),
    },
    components: {
      'upload-file': UploadFile,
      'fast-reply': FastReply
    },
    beforeCreate: function() {
      document.getElementsByTagName("body")[0].className = "bg3";
    },
    created () {
      this.getMessWindowList()
      this.getUserTags()
      this.sendMessStatus()
    },
    methods: {
      initSwiper () {
        this.$nextTick(() => {
          const swiper = new Swiper('.swiper-container', {
            pagination: {
              el: '.swiper-pagination',
            },
          });
        })
      },
      sendMessStatus () {
        if (this.sendProductMess) {
          this.sendMess = this.sendProductMess
        } else if (this.sendProposalMess) {
          this.sendMess = this.sendProposalMess
        } else if (this.sendArticleMess) {
          this.sendMess = this.sendArticleMess
        }
        if (this.sendMess) {
          this.messSubmit()
        }
      },
      getUserTags () {
        const _data = {
          resultId: '05bb595663f14379a83e9cdd8b20369a',
          saasId: tool.app.saasId
        }
        api_sell.queryCustomerPortrait(_data).then(data => {
          if (data.status === tool.rtCode.status) {
            this.tagsList = data.tagsName
            if (this.tagsList.length>3) {
              this.tagsListDown = this.tagsList.slice(0, 3)
            } else {
              this.tagsListDown = this.tagsList
            }
          }
        })
      },
      getMessWindowList () {
        const _data = {
          saasId: tool.app.saasId,
          userId: this.uid,
          appId: this.aid
        }
        api_mess.getOneTalkList(_data).then(data => {
          if (data.status === tool.rtCode.status) {
            this.messList = data.funRealTimeMessageDTOList
            this.handleScroll()
          }
        })
      },
      messSubmit () {
        if (!this.sendMess) return tool.toastMessage('发送内容不能为空，请重新输入')
        const _data = {
          toUserName: this.oid,
          fromUserName: this.aid,
          createTime: new Date().getTime(), // 发送时间
          msgType: 'text', // 消息类型
          picUrl: this.sendPhoto,
          content: this.sendMess, // 文本消息内容
          appId: this.aid
        }
        api_mess.readTimeWindow(_data).then(data => {
          if (data.status === tool.rtCode.status) {
            this.sendMess = ''
            if (this.sendProductMess) {
              DataSource.del('sendProductMess', 2)
              this.sendProductMess = ''
            } else if (this.sendProposalMess) {
              DataSource.del('sendProposalMess', 2)
              this.sendProposalMess = ''
            } else if (this.sendArticleMess) {
              DataSource.del('sendArticleMess', 2)
              this.sendArticleMess = ''
            }
            this.getMessWindowList()
            tool.toastMessage('发送成功')
          } else {
            tool.toastMessage(data.message, 'error')
          }
        })
      },
      handleTagMore () {
        if (this.tagsList.length > 3) {
          this.tagStatus = !this.tagStatus
        }
      },
      otherFile () {
        this.fileStatus = !this.fileStatus
        this.initSwiper()
        this.handleScroll()
      },
      handleSendReply () {
        this.fileStatus = false
        this.replyPopStatus = true
      },
      sendSharePath (path) {
        switch (path) {
          case 'productList':
            DataSource.set('messPath', 'messWindow', 2)
            this.$router.push({path: '/' + path})
            break;
          default:
            this.$router.push({path: '/' + path + '/2'})
        }
      },
      handleScroll () {
        this.$nextTick(() => {
          let messWin = document.getElementsByClassName('chatting-wrapper')[0],
            messBox = document.getElementsByClassName('message-box'),
            messHeight = 0
          for (let it of messBox) {
            messHeight += it.offsetHeight
          }
          messHeight = messHeight > 100 ? messHeight-100 : 0
          messWin.scrollTop = messHeight
        })
      },
      goBack () {
        this.$router.back()
      },
      iptFileFun (params) {
        console.log(params)
        if (params && params.url) {
          this.sendPhoto = params.url
          this.messSubmit()
        }
      },
      sendFastReplyFun (params) {
        this.replyPopStatus = false
        if (params && params.content) {
          this.sendMess = params.content
          this.messSubmit()
        }
      },
    },
    beforeDestroy: function() {
      DataSource.del('messUser', 2)
      document.body.removeAttribute("class", "bg3")
    },
  }
</script>

<style scoped>
  .wrap{word-wrap:break-word;word-break:break-all;}
</style>
